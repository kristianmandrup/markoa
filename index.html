<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <title>Markoa by kristianmandrup</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Markoa</h1>
        <h2>Markoa server</h2>

        <section id="downloads">
          <a href="https://github.com/kristianmandrup/markoa/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/kristianmandrup/markoa/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/kristianmandrup/markoa" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1>
<a id="markoa" class="anchor" href="#markoa" aria-hidden="true"><span class="octicon octicon-link"></span></a>Markoa</h1>

<p>Markoa is a Full stack framework (mostly backend), for rapid prototyping of applications using mock data that can easily be replaced with real services and other data sources... </p>

<p>Markoa is built on Koa.js, Marko.js and leverages Jade templating to boot.</p>

<p><em>Note: This project is currently available as <code>marooka</code> since <code>markoa</code> was already taken on <code>npm</code></em></p>

<h2>
<a id="mounting-apps" class="anchor" href="#mounting-apps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mounting apps</h2>

<p>Mount a basic Markoa app on a Koa.js server as follows:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c1">module</span>.exports <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>marooka<span class="pl-pds">'</span></span>).AppMounter(<span class="pl-c1">__dirname</span>).mountApps([<span class="pl-s"><span class="pl-pds">'</span>index<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>projects<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>login<span class="pl-pds">'</span></span>]).<span class="pl-c1">start</span>();</pre></div>

<p>Note: By default the Koa server will use port <code>4000</code> if no extra settings are provided.</p>

<h3>
<a id="app-file-structure" class="anchor" href="#app-file-structure" aria-hidden="true"><span class="octicon octicon-link"></span></a>App file structure</h3>

<p>For any custom app structure, you may supply your own <code>findTemplate</code> and <code>pageData</code> functions in the app <code>config</code> Object when mounting your apps.</p>

<p>The project file structure should look as follows.</p>

<pre><code>/apps
  /_global
    /components - custom taglibs and tags
      /tags
        /feed
          /project-feed
            marko-tag.json
            renderer.js
            template.jade
            template.marko
        marko-taglib.json
      /widgets
        marko-taglib.json
      marko-taglib.json

    /data - data available to all apps as $out.global
      index.js
      /available
        index.js
        categories.js        
        ...
      /feeds
        index.js

    /layouts - generic layouts
      layout.jade
      item-layout.jade
      list-layout.jade

  /index - app
    meta.js  - app meta data
    /components - app specific components
      marko-taglib.json

    /layouts - special page layouts
      mobile.jade
      base.jade

    /page - page for app
      app.jade
      app.marko
      /dependencies
        broser.json
        app.browser.json - lasso config file
        widgets.json

    /data - data for index app, available as $data
      global.js - reuse global data from local app
      index.js - local data for index app only

    marko-taglib.json

  /repositories - app
    meta.js
    ...
  /teams - app
  ...
marko-taglib.json  
</code></pre>

<h3>
<a id="generating-apps" class="anchor" href="#generating-apps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generating apps</h3>

<p>The generator <a href="https://github.com/kristianmandrup/slush-markoa">slush-markoa</a> can be used to generate projects and other artifacts.</p>

<p>Generate a new app:</p>

<p><code>slush markoa:app</code></p>

<p>This generator will create an app under <code>apps/[app-name]</code> similar to the default <code>index</code> app generated by the default marko generator. Use this generator each time you want to add an app!</p>

<div class="highlight highlight-source-shell"><pre>/[app]
  /components
    /tags
      /project-feed
        template.jade
        ...
  /layouts
    base.jade
  /data
    global.js
    index.js
  /page
    meta.js
    app.jade
    app.marko
    /dependencies
      app.browser.json
  marko-taglib.json</pre></div>

<h3>
<a id="sub-pages" class="anchor" href="#sub-pages" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sub pages</h3>

<p><em>Experimantal: WIP</em></p>

<p>Sometimes an app contains sub pages. To support this, markoa can mount nested sub-routes for a given app. Each sub app will inherit from its parent app if it doesn't provide its own template, data, meta etc.</p>

<pre><code>/apps
  /users
    meta.js
    index.js

    /apps
      /details - nested app
        /page
          app.jade
      /secret - nested app
        meta.js
        /data
          index.js

    /page
      app.jade
      app.marko

      /dependencies
        app.browser.json
</code></pre>

<p>If an app contains a nested <code>/apps</code> folder Markoa will create sub apps that are mounted as sub routes. All The sub-pages can extend or override the parent app properties, to provide its own data, template etc. if needed.</p>

<h4>
<a id="working-example" class="anchor" href="#working-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Working example</h4>

<p>Currently a working example using this infrastructure can be seen for the project page of <a href="https://github.com/kristianmandrup/repo-manager-v3">Repo Manager</a></p>

<h3>
<a id="rest-methods" class="anchor" href="#rest-methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>REST methods</h3>

<p>Each app should have an <code>index.js</code> as the entry point to expose the main parts of the app.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">/*jslint node: true */</span>
<span class="pl-s"><span class="pl-pds">'</span>use strict<span class="pl-pds">'</span></span>;

<span class="pl-c1">module</span>.exports <span class="pl-k">=</span> {
  meta<span class="pl-k">:</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./meta<span class="pl-pds">'</span></span>),
  data<span class="pl-k">:</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./data<span class="pl-pds">'</span></span>),
  apps<span class="pl-k">:</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./apps<span class="pl-pds">'</span></span>),
  methods<span class="pl-k">:</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./methods<span class="pl-pds">'</span></span>),
};</pre></div>

<p>Define your REST-like methods:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">/*jslint node: true */</span>
<span class="pl-s"><span class="pl-pds">'</span>use strict<span class="pl-pds">'</span></span>;
methods<span class="pl-k">:</span> {
  <span class="pl-en">post</span><span class="pl-k">:</span> <span class="pl-k">function*</span>(<span class="pl-smi">next</span>) {
    <span class="pl-en">console</span><span class="pl-c1">.log</span>(<span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span>);
    <span class="pl-k">yield</span> next;
  },
  update<span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">'</span><span class="pl-en">.</span><span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-k">function*</span>(<span class="pl-smi">next</span>) {
      <span class="pl-en">console</span><span class="pl-c1">.log</span>(<span class="pl-s"><span class="pl-pds">'</span>UPDATE<span class="pl-pds">'</span></span>);
      <span class="pl-k">yield</span> next;
    },
    <span class="pl-s"><span class="pl-pds">'</span><span class="pl-en">:id</span><span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-k">function*</span>(<span class="pl-smi">next</span>) {
      <span class="pl-en">console</span><span class="pl-c1">.log</span>(<span class="pl-s"><span class="pl-pds">'</span>UPDATE by id:<span class="pl-pds">'</span></span>, <span class="pl-v">this</span>.<span class="pl-c1">id</span>);
      <span class="pl-k">yield</span> next;
    },
  }
}</pre></div>

<p>The <code>methods</code> entry allows you to define REST endpoints for mutation actions such as:</p>

<ul>
<li>  POST</li>
<li>  PUT</li>
<li>  DELETE</li>
</ul>

<p>You can however use more intuitive action names such as: <code>create</code>, <code>update</code> and <code>remove</code> and they will be mapped to the appropriate <a href="http://www.restapitutorial.com/lessons/httpmethods.html">HTTP methods</a>.</p>

<p>You are responsible for taking it from there... (currently). We might add support for common REST patterns soon, such as <code>:id</code> for single item operations.</p>

<h3>
<a id="custom-routes" class="anchor" href="#custom-routes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom routes</h3>

<p><em>WIP: Coming soon</em></p>

<p>The app <code>index.js</code> will soon be enhanced with a routes section like this:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// index.js</span>
<span class="pl-c1">module</span>.exports <span class="pl-k">=</span> {
  meta<span class="pl-k">:</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./meta<span class="pl-pds">'</span></span>),
  data<span class="pl-k">:</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./data<span class="pl-pds">'</span></span>),
  routes<span class="pl-k">:</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./routes<span class="pl-pds">'</span></span>)
}</pre></div>

<p>The routes can be defined with paramssuch as <code>:id</code> which will automatically be available to the template directly in the data via. the <code>params</code> object, such as <code>data.params.id</code>.</p>

<p>This is achieved via Koa <em>Named route parameters</em> which are automatically captured and added to <code>ctx.params</code></p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// routes.js</span>
<span class="pl-c1">module</span>.exports <span class="pl-k">=</span> {
  <span class="pl-s"><span class="pl-pds">'</span>.<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>app<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>:id<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>item<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span><span class="pl-en">/list/:id</span><span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">name</span>, <span class="pl-smi">config</span>) {
    <span class="pl-c">// Note: Page data is available via config, which includes params etc.</span>
    <span class="pl-c">// Can be used to decide which template to return!</span>
    <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">'</span>list<span class="pl-pds">'</span></span>;
  }
}</pre></div>

<h4>
<a id="named-routes" class="anchor" href="#named-routes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Named routes</h4>

<p><em>WIP</em></p>

<p>We will shortly add support for Koa named routes ;)</p>

<p>"Routes can optionally have names. This allows generation of URLs and easy renaming of URLs during development."</p>

<div class="highlight highlight-source-js"><pre>router.get(<span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>/users/:id<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> <span class="pl-k">*</span>(<span class="pl-smi">next</span>) {
 <span class="pl-c">// ...</span>
});

router.url(<span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>, <span class="pl-c1">3</span>);
<span class="pl-c">// =&gt; "/users/3"</span></pre></div>

<p>We will also add built-in support for <em>Parameter middleware</em> as it is super powerful!</p>

<div class="highlight highlight-source-js"><pre>router
  .param(<span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> <span class="pl-k">*</span>(<span class="pl-smi">id</span>, <span class="pl-smi">next</span>) {
    <span class="pl-v">this</span>.user <span class="pl-k">=</span> users[id];
    <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.user) <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-c1">status</span> <span class="pl-k">=</span> <span class="pl-c1">404</span>;
    <span class="pl-k">yield</span> next;
  })
  .get(<span class="pl-s"><span class="pl-pds">'</span>/users/:user<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> <span class="pl-k">*</span>(<span class="pl-smi">next</span>) {
    <span class="pl-v">this</span>.<span class="pl-c1">body</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.user;
  })
  .get(<span class="pl-s"><span class="pl-pds">'</span>/users/:user/friends<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> <span class="pl-k">*</span>(<span class="pl-smi">next</span>) {
    <span class="pl-v">this</span>.<span class="pl-c1">body</span> <span class="pl-k">=</span> <span class="pl-k">yield</span> <span class="pl-v">this</span>.user.getFriends();
  })
  <span class="pl-c">// /users/3 =&gt; {"id": 3, "name": "Alex"}</span>
  <span class="pl-c">// /users/3/friends =&gt; [{"id": 4, "name": "TJ"}]</span></pre></div>

<p>Routes are added via:</p>

<div class="highlight highlight-source-js"><pre>app.use(router.routes());
app.use(router.allowedMethods());</pre></div>

<h3>
<a id="app-meta-data-and-inheritance" class="anchor" href="#app-meta-data-and-inheritance" aria-hidden="true"><span class="octicon octicon-link"></span></a>App Meta data and inheritance</h3>

<p>An app folder can contain a <code>meta.js</code> file to define meta data for the app.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c1">module</span>.exports <span class="pl-k">=</span> {
  type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>item<span class="pl-pds">'</span></span>, <span class="pl-c">// or: home, list, ...</span>
  form<span class="pl-k">:</span> <span class="pl-c1">true</span>, <span class="pl-c">// if it contains a form to edit the item</span>
  inherit<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>item<span class="pl-pds">'</span></span>, <span class="pl-c">// app to inherit from for all</span>
  page<span class="pl-k">:</span> {
    <span class="pl-c">// type: 'item',</span>
    app<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>item<span class="pl-pds">'</span></span> <span class="pl-c">// app to use for page if no page found here</span>
  },
  data<span class="pl-k">:</span> {
    <span class="pl-c">// type: 'item',</span>
    <span class="pl-c">// app: 'item' app to use as data source if no data here</span>
  }
}</pre></div>

<h4>
<a id="inheritance-and-reuse" class="anchor" href="#inheritance-and-reuse" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inheritance and reuse</h4>

<p>The meta data can be used to indicate which apps to fall back to (inherit from) for the template and data used so as to reuse from other apps and thus minimize duplication.</p>

<h4>
<a id="stats" class="anchor" href="#stats" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stats</h4>

<p>The meta data can also be used to gather stats about the app in aggregate, f.ex to list all the apps that display lists, have forms etc.</p>

<h3>
<a id="using-app-inheritance" class="anchor" href="#using-app-inheritance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using App inheritance</h3>

<p>Let's say we have global data:</p>

<div class="highlight highlight-source-js"><pre>lists<span class="pl-k">:</span> {
  projects<span class="pl-k">:</span> [...],
  teams<span class="pl-k">:</span> [...]
}</pre></div>

<p>Ideally we would like to have this global data available for reference but also to reuse this data at the app level as local data. To enable this, each local <code>/data</code> folder has a <code>global.js</code> which exports all the global data which can then be referenced locally as follows.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> _ <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./global<span class="pl-pds">'</span></span>);
<span class="pl-c1">module</span>.exports <span class="pl-k">=</span> {
  <span class="pl-c">// See global data, lists/projects</span>
  <span class="pl-c">// out.global.lists.projects</span>
  page<span class="pl-k">:</span> {
    name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>projects<span class="pl-pds">'</span></span>,
    title<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Projects<span class="pl-pds">'</span></span>,
    list<span class="pl-k">:</span> _.lists.projects;
  }
}</pre></div>

<p>So here we set up a local generic <code>list</code> to point to the global data <code>list.projects</code>. This can then be passed to whatever list generator which knows how to populate and render a given type of list. Magic!</p>

<p>Using this approach, any app which which displays a model or list using the same renderer, can be set up to inherit from a generic app which handles it.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c1">module</span>.exports <span class="pl-k">=</span> {
  type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>list<span class="pl-pds">'</span></span>,
  page<span class="pl-k">:</span> {
    app<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>list<span class="pl-pds">'</span></span>
  }
}</pre></div>
      </section>
    </div>

    
  </body>
</html>
