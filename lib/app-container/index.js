'use strict';
let extend = require('extend');

// new appContainer(opts)
module.exports = function(opts) {
  opts = opts || {debug: false};
  let Mounter = require('./mounter');
  let Routes = require('./routes');

  let appContainer = {
    apps: {},
    debug: opts.debug,
    log: function(msg, obj) {
      if (!opts.debug) return;
      obj ? this.logger(msg, obj) : this.logger(msg);
    },
    logger: opts.logger || console.log,
    state: {
      page: {}, // for any page
      $global: {}
    },
    join: function(appContainer) {
      extend(apps, appContainer.apps);
      return this;
    },
    createRoutes: function(koaApp) {
      this.koaApp = this.koaApp || koaApp;
      this.routes = new Routes(this);
      for (let name of Object.keys(this.apps)) {
        let config = this.apps[name];
        this.routes.add(name, config);
      }
      return this;
    },
    // A koaApp is generated by calling koa() which creates a Koa server app instance
    start: function(koaApp) {
      this.koaApp = this.koaApp || koaApp;
      if (!this.routes) createRoutes();
      // TODO: createRoutes if not created
      this.koaApp.koaServer.start();
      return this;
    },
    Mounter: Mounter,
    Routes: Routes
  };
  appContainer.mount = new Mounter(appContainer);
  return appContainer;
}
